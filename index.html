<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Live 4th of July Transit Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/protobufjs/dist/protobuf.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f0f8ff; }
    h1 { text-align: center; }
    .section { border-left: 4px solid #aaa; margin: 20px 0; padding: 10px 20px; background: #fff; }
    .label { font-weight: bold; }
    .live { color: #c0392b; font-size: 1.1em; }
    #clock { text-align: center; margin-top: 10px; font-size: 1.2em; }
  </style>
</head>
<body>
  <h1>ğŸ† 4th of July Transit Tracker</h1>
  <div id="clock">Loading current time...</div>

  <div class="section">
    <div class="label">ğŸš AC Transit (Route 7 at College & Derby)</div>
    <div class="live" id="ac-next">Loading...</div>
  </div>

  <div class="section">
    <div class="label">ğŸš‡ BART (Downtown Berkeley â†’ Embarcadero)</div>
    <div class="live" id="bart-next">Loading...</div>
  </div>

  <div class="section">
    <div class="label">ğŸš‹ Cable Car (CA at California & Drumm)</div>
    <div class="live" id="cable-next">Loading...</div>
  </div>

  <div class="section">
    <div class="label">ğŸš Muni (Route 1 at Pacific & Mason)</div>
    <div class="live" id="muni-next">Loading...</div>
  </div>

  <div class="section">
    <div class="label">â›´ï¸ Ferry to Sausalito</div>
    <div class="live">Departures: 10:15 AM, 12:35 PM, 2:15 PM, 4:00 PM, 5:50 PM (Gate B)</div>
  </div>

  <div class="section">
    <div class="label">ğŸšŒ Golden Gate Transit (Route 130 at Bridgeway & El Portal)</div>
    <div class="live" id="ggt-next">Loading...</div>
  </div>

  <script>
    const API_KEY = "706b0620-4d76-4883-b9c3-6ef6182a2bcd"; // Replace with your 511.org API key
    const BART_KEY = "MW9S-E7SL-26DU-VV8V";

    setInterval(() => {
      document.getElementById("clock").textContent = "Current Time: " + new Date().toLocaleTimeString();
    }, 1000);

    async function getBART() {
      const url = `https://api.bart.gov/api/etd.aspx?cmd=etd&orig=DBRK&key=${BART_KEY}&json=y`;
      const d = await fetch(url).then(r => r.json());
      for (let e of d.root.station[0].etd) {
        if (e.abbreviation === "EMBR") return e.estimate[0].minutes + " min";
      }
      return "Unavailable";
    }

    async function fetchGtfs(path) {
      const res = await fetch(`https://api.511.org/transit/${path}&api_key=${API_KEY}`);
      const buf = await res.arrayBuffer();
      const root = await protobuf.load("https://cdn.jsdelivr.net/npm/gtfs-realtime-bindings/gtfs-realtime.proto");
      return root.lookupType("transit_realtime.FeedMessage").decode(new Uint8Array(buf));
    }

    async function getNextStop(feed, stopId, routeId) {
      try {
        const feedMsg = await fetchGtfs(feed);
        const now = Date.now()/1000;
        let best = Infinity;
        feedMsg.entity.forEach(ent => {
          const tu = ent.tripUpdate;
          if (tu?.trip?.routeId === routeId) {
            (tu.stopTimeUpdate||[]).forEach(stu => {
              if (stu.stopId === stopId && stu.arrival?.time > now) {
                best = Math.min(best, stu.arrival.time - now);
              }
            });
          }
        });
        return isFinite(best) ? Math.round(best/60) + " min" : "Unavailable";
      } catch {
        return "Unavailable";
      }
    }

    async function updateAll() {
      document.getElementById("ac-next").textContent = await getNextStop("TripUpdates?agency=AC", "59977", "7");
      document.getElementById("bart-next").textContent = await getBART();
      document.getElementById("cable-next").textContent = await getNextStop("TripUpdates?agency=SF", "13860", "CA");
      document.getElementById("muni-next").textContent = await getNextStop("TripUpdates?agency=SF", "15387", "1");
      document.getElementById("ggt-next").textContent = await getNextStop("TripUpdates?agency=GGT", "10357", "130");
    }

    updateAll();
    setInterval(updateAll, 30000);
  </script>
</body>
</html>
