<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Live 4th of July Transit Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://raw.githubusercontent.com/google/transit/master/gtfs-realtime/proto/gtfs-realtime.proto
"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f0f8ff; }
    h1 { text-align: center; }
    .section { border-left: 4px solid #aaa; margin: 20px 0; padding: 10px 20px; background: #fff; }
    .active { border-left-color: #3498db; background: #eaf6ff; }
    .label { font-weight: bold; }
    .live { color: #c0392b; font-size: 1.1em; }
    #clock { text-align: center; margin-top: 10px; font-size: 1.2em; }
  </style>
</head>
<body>
  <h1>üéÜ 4th of July Transit Tracker</h1>
  <div id="clock">Loading current time...</div>

  <div class="section" id="ac">
    <div class="label">üöç AC Transit (7)</div>
    <div class="live" id="ac-next">Loading...</div>
  </div>

  <div class="section" id="bart">
    <div class="label">üöá BART (Downtown Berkeley ‚Üí Embarcadero)</div>
    <div class="live" id="bart-next">Loading...</div>
  </div>

  <div class="section" id="cable">
    <div class="label">üöã Cable Car (California Line)</div>
    <div class="live" id="cable-next">Loading...</div>
  </div>

  <div class="section" id="muni">
    <div class="label">üöç Muni (1 California)</div>
    <div class="live" id="muni-next">Loading...</div>
  </div>

  <div class="section" id="ferry">
    <div class="label">‚õ¥Ô∏è Ferry to Sausalito</div>
    <div class="live">Next Departures: 10:15 AM, 12:35 PM, 2:15 PM, 4:00 PM, 5:50 PM (Gate B)</div>
  </div>

  <div class="section" id="gg">
    <div class="label">üöå Golden Gate Transit (130)</div>
    <div class="live" id="gg-next">Loading...</div>
  </div>

  <script>
    const API_KEY_511 = "706b0620-4d76-4883-b9c3-6ef6182a2bcd";  // Replace with your real 511.org key
    const BART_API_KEY = "MW9S-E7SL-26DU-VV8V";

    const updateClock = () => {
      const now = new Date();
      document.getElementById("clock").textContent =
        "Current Time: " + now.toLocaleTimeString();
    };
    setInterval(updateClock, 1000);
    updateClock();

    async function getBARTETD(origin = "DBRK", destination = "EMBR") {
      const url = `https://api.bart.gov/api/etd.aspx?cmd=etd&orig=${origin}&key=${BART_API_KEY}&json=y`;
      const data = await fetch(url).then(r => r.json());
      const etdList = data.root.station[0]?.etd || [];
      for (let e of etdList) {
        if (e.abbreviation === destination || e.destination.includes("SFO")) {
          return e.estimate[0]?.minutes + " min";
        }
      }
      return "Unavailable";
    }

    async function fetchGtfsRt(feedPath) {
      const url = `https://api.511.org/transit/${feedPath}&api_key=${API_KEY_511}`;
      const res = await fetch(url);
      const buffer = await res.arrayBuffer();
      const root = await protobuf.load("https://cdn.jsdelivr.net/npm/gtfs-realtime-bindings/gtfs-realtime.proto");
      const FeedMessage = root.lookupType("transit_realtime.FeedMessage");
      return FeedMessage.decode(new Uint8Array(buffer));
    }

    async function getRtArrival(feed, stopID, routeID) {
      try {
        const decoded = await fetchGtfsRt(feed);
        const now = Date.now() / 1000;
        let min = Infinity;
        decoded.entity.forEach(ent => {
          const tu = ent.tripUpdate;
          if (!tu || tu.trip.routeId !== routeID) return;
          tu.stopTimeUpdate?.forEach(stu => {
            if (stu.stopId === stopID && stu.arrival?.time > now) {
              min = Math.min(min, stu.arrival.time - now);
            }
          });
        });
        return isFinite(min) ? Math.round(min / 60) + " min" : "Unavailable";
      } catch {
        return "Unavailable";
      }
    }

    async function updateLiveData() {
      document.getElementById("ac-next").textContent =
        await getRtArrival(FEED, "59977", "7"); // Replace STOP_AC
      document.getElementById("bart-next").textContent =
        await getBARTETD("DBRK", "EMBR");
      document.getElementById("cable-next").textContent =
        await getRtArrival(FEED, "13880", "CA"); // Replace STOP_CABLE
      document.getElementById("muni-next").textContent =
        await getRtArrival(FEED, "15848", "12"); // Replace STOP_MUNI
      document.getElementById("gg-next").textContent =
        await getRtArrival(FEED, "40101", "130"); // Replace STOP_GG
    }

    updateLiveData();
    setInterval(updateLiveData, 30000);
  </script>
</body>
</html>
